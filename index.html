<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
    /* ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤: ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡¶ó‡ßÅ‡¶≤‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
    .work-entry {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
    }
    @media (min-width: 640px) {
        .work-entry {
            grid-template-columns: 2fr 1fr 1fr 1fr 20px;
        }
    }
    .production-card {
        cursor: pointer; 
        transition: transform 0.1s;
    }
    .production-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .modal-input {
        padding: 6px;
        font-size: 0.875rem; /* text-sm */
    }
    .work-input-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
    }
    @media (min-width: 640px) {
        .work-input-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-6 mt-12">
<div id="header-placeholder"></div>
<div id="loader" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
<div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-600"></div>
</div>

<div class="max-w-6xl mx-auto hidden" id="mainContent">

<div class="bg-white shadow-lg rounded-lg p-4 mb-6">
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4 justify-items-center">

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ</label>
<select id="filterWorker" class="border rounded p-2 w-full text-sm">
<option value="">‡¶∏‡¶¨</option>
</select>
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶Æ‡ßá‡¶∂‡¶ø‡¶®</label>
<select id="filterMachine" class="border rounded p-2 w-full text-sm">
<option value="">‡¶∏‡¶¨</option>
</select>
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶Æ‡¶æ‡¶∏</label>
<select id="filterMonth" class="border rounded p-2 w-full text-sm"></select>
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶¨‡¶õ‡¶∞</label>
<select id="filterYear" class="border rounded p-2 w-full text-sm"></select>
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶•‡ßá‡¶ï‡ßá</label>
<input type="date" id="filterFrom" class="border rounded p-2 w-full text-sm">
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§</label>
<input type="date" id="filterTo" class="border rounded p-2 w-full text-sm">
</div>

<div class="w-full max-w-[140px] flex gap-2 justify-center items-end">
    <button id="clearFilter" type="button" class="addRowBtn px-2 py-1 bg-red-600 text-white rounded hover:bg-indigo-700 flex items-center justify-center">
    <i data-lucide="x-circle" class="w-5 h-5 mr-1"></i>
    ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞
    </button>
</div>
<div class="w-full max-w-[140px] flex gap-2 justify-center items-end whitespace-nowrap ">
    <a id="addStitchButton" href="add-stitch.html" class="hidden">
        <button type="button" class="addRowBtn px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 flex items-center justify-center">
        <i data-lucide="plus-circle" class="w-5 h-5 mr-1"></i>
        ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </a>
</div>

</div>
</div>

<div id="summaryCards" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
<div id="totalProductionCard" class="bg-white shadow rounded p-3 text-center">
<h3 class="text-gray-500 text-xs">‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®</h3>
<p id="totalProductionValue" class="text-xl font-bold text-indigo-700">0</p>
</div>
<div id="averageProductionCard" class="bg-white shadow rounded p-3 text-center">
<h3 class="text-gray-500 text-xs">‡¶ó‡¶°‡¶º ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®</h3>
<p id="averageProductionValue" class="text-xl font-bold text-green-600">0</p>
</div>

<div id="workdayProductionCard" class="bg-white shadow rounded p-3 text-center">
<h3 class="text-gray-500 text-xs">‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®</h3>
<p id="workdayProductionValue" class="text-xl font-bold text-indigo-700">0</p>
</div>
<div id="targetProductionCard" class="bg-white shadow rounded p-3 text-center">
<h3 class="text-gray-500 text-xs">‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®</h3>
<p id="targetProductionValue" class="text-xl font-bold text-green-600">0</p>
</div>

<div id="determinedSalaryCard" class="bg-white shadow rounded p-3 text-center">
    <h3 class="text-gray-500 text-xs">‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡ßá‡¶§‡¶® (‡¶Æ‡ßã‡¶ü)</h3>
    <p id="determinedSalaryValue" class="text-xl font-bold text-red-600">0</p>
</div>
<div id="earnedSalaryCard" class="bg-white shadow rounded p-3 text-center">
    <h3 class="text-gray-500 text-xs">‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶Ø ‡¶¨‡ßá‡¶§‡¶® (‡¶Æ‡ßã‡¶ü)</h3>
    <p id="earnedSalaryValue" class="text-xl font-bold text-blue-600">0</p>
</div>
</div>

<div class="bg-white shadow-lg rounded-lg p-6 text-center">

<h2 class="text-xl font-bold text-indigo-700 mb-4 text-center" id="tableTitle">üìã ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>

<div id="productionList" class="space-y-3">
    </div>

</div>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl overflow-y-auto max-h-[90vh]">
        <h3 class="text-xl font-bold mb-4 text-center" id="modalTitle">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
        
        <form id="productionForm" class="space-y-4">
            <input type="hidden" id="modalProductionId">

            <div class="grid grid-cols-2 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-600 text-sm">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                    <input type="date" id="modalDate" class="border rounded p-2 w-full modal-input" disabled>
                </div>
                <div>
                    <label class="block text-gray-600 text-sm">‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ</label>
                    <select id="modalWorker" class="border rounded p-2 w-full modal-input" disabled></select>
                </div>
                <div>
                    <label class="block text-gray-600 text-sm">‡¶Æ‡ßá‡¶∂‡¶ø‡¶®</label>
                    <input type="text" id="modalMachine" class="border rounded p-2 w-full modal-input" disabled>
                </div>
                <div>
                    <label class="block text-gray-600 text-sm">‡¶Æ‡ßã‡¶ü ‡¶∏‡ßç‡¶ü‡¶ø‡¶ö</label>
                    <input type="text" id="modalGrandTotal" class="border rounded p-2 w-full modal-input bg-gray-100" disabled>
                </div>
            </div>

            <hr>
            <h4 class="font-bold text-lg mb-2 text-center">‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§:</h4>
            
            <div class="grid gap-2 text-sm font-semibold text-gray-700 border-b-2 border-gray-300 pb-1 hidden sm:grid sm:grid-cols-[2fr_1fr_1fr_1fr_20px]">
                <span class="coll-span-1 text-left">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶®‡¶æ‡¶Æ</span>
                <span class="col-span-1 text-right">‡¶∏‡ßç‡¶ü‡¶ø‡¶ö (Stitch)</span>
                <span class="col-span-1 text-right">‡¶¨‡ßç‡¶Ø‡¶æ‡¶∏ (Quantity)</span>
                <span class="col-span-1 text-right">‡¶Æ‡ßã‡¶ü (Total)</span>
                <span></span>
            </div>

            <div id="modalWorksContainer" class="space-y-4">
                </div>

            <div id="adminControls" class="mt-6 flex justify-between">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                
                <div id="editDeleteButtons" class="space-x-4 hidden">
                    <button type="button" id="editButton" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="enableEditMode()">‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button type="submit" id="updateButton" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 hidden">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>
                    <button type="button" id="deleteButton" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 hidden" onclick="deleteProduction()">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                </div>
            </div>
        </form>

    </div>
</div>

</div>

<div id="footer-placeholder"></div>
<script src="include-loader.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// üîπ Firebase Config (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®)
const firebaseConfig = {
    apiKey: "AIzaSyCdVxsSPUirznH-67MoHln3kdyPS1SMB94",
    authDomain: "asembroidery-5cd5e.firebaseapp.com",
    projectId: "asembroidery-5cd5e",
    storageBucket: "asembroidery-5cd5e.appspot.com",
    messagingSenderId: "592758047307",
    appId: "1:592758047307:web:d4f7d69bcd9f0398ac83ce"
};

// üîπ Firebase Initialization
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// üîπ DOM Elements (‡¶è‡¶ï‡¶á)
const productionList = document.getElementById("productionList");
const filterFrom = document.getElementById("filterFrom");
const filterTo = document.getElementById("filterTo");
const filterMachine = document.getElementById("filterMachine");
const filterWorker = document.getElementById("filterWorker");
const filterMonth = document.getElementById("filterMonth");
const filterYear = document.getElementById("filterYear");
const clearFilter = document.getElementById("clearFilter");
const tableTitle = document.getElementById("tableTitle");
const loader = document.getElementById("loader");
const mainContent = document.getElementById("mainContent");
const addStitchButton = document.getElementById("addStitchButton");
const determinedSalaryValue = document.getElementById("determinedSalaryValue");
const earnedSalaryValue = document.getElementById("earnedSalaryValue");
const modalWorksContainer = document.getElementById("modalWorksContainer");
const productionForm = document.getElementById("productionForm");
const editDeleteButtons = document.getElementById("editDeleteButtons");

const monthNames = ["‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];

let allProductions = [];
let allWorkers = [];
let currentUserRole = ""; 

// üéØ ‡¶ï‡¶®‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü (‡¶è‡¶ï‡¶á)
const WORKER_CATEGORY_ID = "6TeDHhrINuMH5SxU6dAr"; 
const TARGET_FIELD_NAME = "productionTarget";
// üéØ ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï, ‡¶∏‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø ‡¶ó‡¶£‡¶®‡¶æ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï ‡¶ì ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶ú ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü)
function calculateCumulativeRank(cumulativeTotal, dailyFixedProduction) { 
    const TARGET_DAYS_FOR_RANK = 28; 
    if (dailyFixedProduction === 0 || dailyFixedProduction === null || isNaN(dailyFixedProduction)) {
        return { rankTitle: '-', rankTargetPercent: 0 }; 
    }
    // ‡ß®‡ßÆ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶ó‡¶£‡¶®‡¶æ
    const monthlyTarget = dailyFixedProduction * TARGET_DAYS_FOR_RANK;
    const rankStep = monthlyTarget / 5; // ‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü‡ßá‡¶∞ ‡ß®‡ß¶%
    const comparisonValue = cumulativeTotal; // ‡¶¨‡¶ø‡¶ó‡¶§ ‡ß©‡ß® ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶â‡ßé‡¶™‡¶æ‡¶¶‡¶®
    if (rankStep === 0) {
        return { rankTitle: '-', rankTargetPercent: 0 }; 
    }
    
    let rankTitle = "‡¶®‡¶§‡ßÅ‡¶®";
    let requiredTarget = 0; // ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™‡ßá‡¶∞ ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü
    let previousTarget = 0; // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ß‡¶æ‡¶™‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ

    // ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    if (comparisonValue >= rankStep * 4) {
        rankTitle = "‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶æ‡¶∞";
        // '‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞'-‡¶è‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï ‡¶®‡ßá‡¶á, ‡¶§‡¶æ‡¶á ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶ß‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        requiredTarget = monthlyTarget * 1.25; // ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ï‡¶≤‡ßç‡¶™‡¶ø‡¶§ ‡¶ß‡¶æ‡¶™
        previousTarget = rankStep * 4;
    } else if (comparisonValue >= rankStep * 3) {
        rankTitle = "‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞";
        requiredTarget = rankStep * 4; // ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™: ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞
        previousTarget = rankStep * 3;
    } else if (comparisonValue >= rankStep * 2) {
        rankTitle = "‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ";
        requiredTarget = rankStep * 3; // ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™: ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ
        previousTarget = rankStep * 2;
    } else if (comparisonValue >= rankStep * 1) {
        rankTitle = "‡¶π‡ßá‡¶≤‡¶™‡¶æ‡¶∞";
        requiredTarget = rankStep * 2; // ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™: ‡¶π‡ßá‡¶≤‡¶™‡¶æ‡¶∞
        previousTarget = rankStep * 1;
    } else {
        rankTitle = "‡¶®‡¶§‡ßÅ‡¶®";
        requiredTarget = rankStep * 1; // ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™: ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï
        previousTarget = 0;
    }
    
    let completionPercent = 0;
    
    const currentStepRange = requiredTarget - previousTarget;
    const progressInStep = comparisonValue - previousTarget;
    
    if (currentStepRange > 0) {
        // progressInStep / currentStepRange * 100
        completionPercent = Math.min(100, (progressInStep / currentStepRange) * 100).toFixed(0);
    } else {
        completionPercent = 100; // ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶æ ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü 0 ‡¶π‡¶≤‡ßá
    }
    
    return { 
        rankTitle: rankTitle, 
        rankTargetPercent: Math.max(0, completionPercent) // ‡¶®‡ßá‡¶ó‡ßá‡¶ü‡¶ø‡¶≠ ‡¶Æ‡¶æ‡¶® ‡¶è‡ßú‡¶æ‡¶®‡ßã
    };
}

function calculateDailySalary(monthlySalary, month, year) {
    if (monthlySalary === 0 || isNaN(monthlySalary)) return 0;
    const daysInMonth = new Date(year, month + 1, 0).getDate(); 
    return monthlySalary / daysInMonth;
}

function calculateEarnedSalary(cumulativeAvg, dailyTarget, totalWorkingDays, determinedDailySalary) {
    if (dailyTarget === 0 || determinedDailySalary === 0 || totalWorkingDays === 0) return 0;
    const performanceRatio = cumulativeAvg / dailyTarget;
    const earnedDailySalary = determinedDailySalary * performanceRatio;
    return earnedDailySalary * totalWorkingDays;
}
// -----------------------------------------------------------------------

// üîπ Load Workers Dropdown (‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü)
async function loadWorkers() {
    filterWorker.innerHTML = `<option value="">‡¶∏‡¶¨</option>`;
    allWorkers = [];
    try {
        const q = query(collection(db, "people"), where("category_key", "==", WORKER_CATEGORY_ID));
        const snapshot = await getDocs(q);
        
        snapshot.forEach(docSnap => {
            const user = docSnap.data();
            user.id = docSnap.id;
            
            // üí° ‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®
            let targetValue = user[TARGET_FIELD_NAME];
            if (targetValue === undefined || targetValue === null) targetValue = 0;
            else targetValue = parseFloat(targetValue);
            user.productionTarget = isNaN(targetValue) ? 0 : targetValue; 
            
            // üí° ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            let fixedValue = user.fixedProduction; // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶®‡ßá‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
            if (fixedValue === undefined || fixedValue === null) fixedValue = 0;
            else fixedValue = parseFloat(fixedValue);
            user.fixedRankTarget = isNaN(fixedValue) ? 0 : fixedValue;
            
            let salaryValue = user.achievedSalary !== undefined ? parseFloat(user.achievedSalary) : 0;
            user.achievedSalary = isNaN(salaryValue) ? 0 : salaryValue;
            
            allWorkers.push(user); 
            const opt = document.createElement("option");
            opt.value = docSnap.id;
            opt.textContent = user.name;
            filterWorker.appendChild(opt);
        });
    } catch (error) {
        console.error("‡¶ï‡¶∞‡ßç‡¶Æ‡ßÄ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá:", error);
    }
}

// üîπ Load Month/Year Dropdowns (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
function loadMonthYearFilters() {
    const now = new Date();
    filterMonth.innerHTML = "";
    monthNames.forEach((name, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.text = name;
        filterMonth.appendChild(opt);
    });
    filterMonth.value = now.getMonth();
    filterYear.innerHTML = "";
    for (let y = now.getFullYear(); y >= now.getFullYear() - 3; y--) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.text = y;
        filterYear.appendChild(opt);
    }
    filterYear.value = now.getFullYear();
}

// üîπ Populate Machines Dropdown (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
function populateMachines(productions) {
    const machines = [...new Set(productions.map(p => p.machine))];
    filterMachine.innerHTML = `<option value="">‡¶∏‡¶¨</option>`;
    machines.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        filterMachine.appendChild(opt);
    });
}

// üîπ Fetch Productions from Firestore (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
async function fetchProductions() {
    loader.style.display = "flex";
    try {
        const q = query(collection(db, "productions"), orderBy("date", "desc"));
        const snapshot = await getDocs(q);
        allProductions = [];
        snapshot.forEach(docSnap => {
            let p = docSnap.data();
            p.id = docSnap.id;
            allProductions.push(p);
        });
        populateMachines(allProductions);
        renderProductions();
    } catch (err) {
        console.error("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ", err);
        productionList.innerHTML = `<div class="text-center py-4 text-red-500">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§</div>`;
    } 
}

// üîπ üí° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ Render Productions (‡ß©‡ß® ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç ‡¶∏‡¶π)
function renderProductions() {
    productionList.innerHTML = "";
    const monthFilter = filterMonth.value !== "" ? parseInt(filterMonth.value) : null;
    const yearFilter = filterYear.value !== "" ? parseInt(filterYear.value) : null;
    const startDate = filterFrom.value ? new Date(filterFrom.value + "T00:00:00") : null;
    const endDate = filterTo.value ? new Date(filterTo.value + "T23:59:59") : null;
    const machineFilter = filterMachine.value;
    const workerFilter = filterWorker.value;

    const filtered = allProductions
        .filter(p => {
            const dateObj = new Date(p.date);
            if (monthFilter !== null && dateObj.getMonth() !== monthFilter) return false;
            if (yearFilter !== null && dateObj.getFullYear() !== yearFilter) return false;
            if (startDate && dateObj < startDate) return false;
            if (endDate && dateObj > endDate) return false;
            if (machineFilter && p.machine !== machineFilter) return false;
            if (workerFilter && p.workerId !== workerFilter) return false;
            return true;
        });

    const monthName = monthFilter !== null ? monthNames[monthFilter] : "‡¶∏‡¶¨ ‡¶Æ‡¶æ‡¶∏";
    tableTitle.textContent = `üìã ${monthName} ¬∑ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®`;
    
    const workerNameMap = allWorkers.reduce((map, worker) => {
        map[worker.id] = worker.name;
        // üí° ‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®
        map[`target-${worker.id}`] = worker.productionTarget || 0; 
        // üí° ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç‡ßü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®
        map[`fixedTarget-${worker.id}`] = worker.fixedRankTarget || 0; 
        map[`salary-${worker.id}`] = worker.achievedSalary || 0;
        return map;
    }, {});


    const groupedData = filtered.reduce((acc, p) => {
        const dateKey = new Date(p.date).toISOString().split('T')[0];
        const workerKey = p.workerId;
        const uniqueKey = `${workerKey}-${dateKey}`;

        if (!acc[uniqueKey]) {
            acc[uniqueKey] = {
                ...p,
                date: dateKey,
                grandTotal: parseFloat(p.grandTotal),
                works: [...p.works],
                id: p.id,
                workerName: workerNameMap[p.workerId] || "‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶ï‡¶∞‡ßç‡¶Æ‡ßÄ",
                // üí° ‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
                dailyTarget: workerNameMap[`target-${p.workerId}`] || 0,
                monthlySalary: workerNameMap[`salary-${p.workerId}`] || 0
            };
        } else {
            acc[uniqueKey].grandTotal += parseFloat(p.grandTotal);
            acc[uniqueKey].works.push(...p.works);
        }
        return acc;
    }, {});

    const groupedArray = Object.values(groupedData);

// ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶æ‡¶® ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
    document.getElementById("totalProductionValue").textContent = "0";
    document.getElementById("averageProductionValue").textContent = "0";
    document.getElementById("workdayProductionValue").textContent = "0";
    document.getElementById("targetProductionValue").textContent = "0"; 
    determinedSalaryValue.textContent = "0"; 
    earnedSalaryValue.textContent = "0";

    if (groupedArray.length === 0) {
        productionList.innerHTML = `<div class="text-center py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</div>`;
        return;
    }

    // üí° ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç‡ßü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶®‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü
    const ROLLING_DAYS_COUNT = 32; 

    // ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç‡ßü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã
    const sortedByDate = [...groupedArray].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // üí° ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶≤‡ßÅ‡¶™: ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡ß©‡ß® ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£
    sortedByDate.forEach((p, index) => {
        const wid = p.workerId;
        const entryDate = new Date(p.date); // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ
        
        // ‡ß©‡ß® ‡¶¶‡¶ø‡¶® ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ó‡¶£‡¶®‡¶æ
        const rollingStartDate = new Date(entryDate);
        rollingStartDate.setDate(entryDate.getDate() - ROLLING_DAYS_COUNT);
        rollingStartDate.setHours(0, 0, 0, 0); 
        
        let rollingCumulativeTotal = 0;
        let rollingWorkingDays = 0;
        
        // üí° ‡¶ì‡¶á ‡¶ï‡¶∞‡ßç‡¶Æ‡ßÄ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ
        const allWorkerGroupedEntries = groupedArray.filter(entry => entry.workerId === wid);
        
        allWorkerGroupedEntries.forEach(entry => {
            const currentEntryDate = new Date(entry.date);
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶ø ‡¶∞‡ßã‡¶≤‡¶ø‡¶Ç ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶•‡¶æ‡¶ï‡ßá (‡¶¨‡¶ø‡¶ó‡¶§ ‡ß©‡ß® ‡¶¶‡¶ø‡¶®)
            if (currentEntryDate >= rollingStartDate && currentEntryDate <= entryDate) {
                rollingCumulativeTotal += entry.grandTotal;
                rollingWorkingDays++;
            }
        });

        // üí° ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç ‡¶ó‡¶£‡¶®‡¶æ
        const fixedTarget = workerNameMap[`fixedTarget-${p.workerId}`] || 0;
        
        // üí° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶è‡¶ñ‡¶® ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡¶õ‡ßá
        const rankResult = calculateCumulativeRank(
            rollingCumulativeTotal, // ‡¶¨‡¶ø‡¶ó‡¶§ ‡ß©‡ß® ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶â‡ßé‡¶™‡¶æ‡¶¶‡¶®
            fixedTarget // üí° ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        );
        
        p.totalRank = rankResult.rankTitle; // ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤
        p.rankTargetPercent = rankResult.rankTargetPercent; // ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ß‡¶æ‡¶™‡ßá‡¶∞ ‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂

        // üí° ‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        p.cumulativeTotal = rollingCumulativeTotal; 
        p.totalWorkDays = rollingWorkingDays; 
        p.cumulativeAvg = rollingWorkingDays > 0 ? p.cumulativeTotal / rollingWorkingDays : 0;
        p.dailyTarget = workerNameMap[`target-${p.workerId}`]; 
        
        p.totalColorClass = "text-gray-800 font-bold"; 
    });

    const sortedForDisplay = groupedArray.sort((a, b) => new Date(b.date) - new Date(a.date));

    // üí° ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶ï‡¶æ‡¶∞‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶®)
    sortedForDisplay.forEach(p => {
        const card = document.createElement("div");
        card.className = "production-card bg-white shadow rounded-lg p-4 border border-gray-200";
        card.onclick = () => viewProduction(p.id); 

        const date = new Date(p.date);
        const formattedDate = date.toLocaleDateString('bn-BD', { day: 'numeric', month: 'short' }); 
        
        // üí° ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡ßã‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶è‡¶ï ‡¶≤‡¶æ‡¶á‡¶®‡ßá
        card.innerHTML = `
            <div class="flex justify-between items-center mb-2 border-b pb-2">
                <span class="text-sm font-semibold text-gray-700">${formattedDate}</span>
                <span class="text-sm text-gray-500">‡¶Æ‡ßá‡¶∂‡¶ø‡¶®‡¶É <span class="font-bold text-gray-800">${p.machine}</span></span>
                <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full">${p.totalRank}</span>
            </div>
            
            <div class="flex flex-col gap-2 text-sm">
                <div class="flex justify-between items-center w-full">
                    <span class="text-sm text-gray-500">‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞‡¶É <span class="font-bold text-gray-800">${p.workerName}</span></span>
                    <span class="text-sm text-gray-500">‡¶Æ‡ßã‡¶ü‡¶É <span class="font-bold text-gray-800">${p.grandTotal}</span></span>
                </div>
                
                <div class="flex flex-col w-full pt-1">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-green-500 h-2.5 rounded-full" style="width: ${p.rankTargetPercent}%;"></div>
                    </div>
                    <p class="text-xs text-center mt-1 text-gray-500">
                        ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï‡ßá ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø: 
                        <span class="font-bold text-green-600">${p.rankTargetPercent}%</span>
                    </p>
                </div>
            </div>
        `;
        productionList.appendChild(card);
    });

    // ... (‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï) ...
    let totalProduction = groupedArray.reduce((sum, p) => sum + p.grandTotal, 0);
    let totalWorkdays = groupedArray.length;
    let averageProduction = totalWorkdays > 0 ? totalProduction / totalWorkdays : 0;
    
    // ... (‡¶∏‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø ‡¶ó‡¶£‡¶®‡¶æ ‡¶≤‡¶ú‡¶ø‡¶ï) ...
    const currentMonth = filterMonth.value !== "" ? parseInt(filterMonth.value) : new Date().getMonth();
    const currentYear = filterYear.value !== "" ? parseInt(filterYear.value) : new Date().getFullYear();
    let totalDeterminedSalary = 0; 
    let totalEarnedSalary = 0;
    let totalTarget = 0;

    let workersToCalculate = allWorkers;
    if (workerFilter) {
        const worker = allWorkers.find(w => w.id === workerFilter);
        if (worker) workersToCalculate = [worker];
    }

    workersToCalculate.forEach(worker => {
        const monthlySalary = worker.achievedSalary || 0; 
        const dailyTarget = worker.productionTarget || 0; // ‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
        totalTarget += dailyTarget;
        totalDeterminedSalary += monthlySalary; 

        const workerProductionEntries = groupedArray.filter(p => p.workerId === worker.id);
        if (workerProductionEntries.length > 0) {
            const workerTotalProduction = workerProductionEntries.reduce((sum, p) => sum + p.grandTotal, 0);
            const workerTotalWorkdays = workerProductionEntries.length;
            const workerAverageProduction = workerTotalProduction / workerTotalWorkdays;
            const determinedDailySalary = calculateDailySalary(monthlySalary, currentMonth, currentYear);
            
            const earnedSalary = calculateEarnedSalary(
                workerAverageProduction, dailyTarget, workerTotalWorkdays, determinedDailySalary          
            );
            totalEarnedSalary += earnedSalary; 
        }
    });


    // ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá ‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶®
    document.getElementById("totalProductionValue").textContent = totalProduction.toFixed(0);
    document.getElementById("averageProductionValue").textContent = averageProduction.toFixed(2);
    document.getElementById("workdayProductionValue").textContent = totalWorkdays;
    document.getElementById("targetProductionValue").textContent = totalTarget.toFixed(0);
    determinedSalaryValue.textContent = totalDeterminedSalary.toFixed(0); 
    earnedSalaryValue.textContent = totalEarnedSalary.toFixed(0);
}


// -----------------------------------------------------------------------
// üí° ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç-‡¶è ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®)
// -----------------------------------------------------------------------

let currentProductionData = null;

window.viewProduction = async function (id) {
    const p = allProductions.find(item => item.id === id) || (await getDoc(doc(db, "productions", id))).data();
    if (!p) return;

    document.getElementById("modalProductionId").value = id;
    document.getElementById("modalTitle").textContent = "‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§";
    
    const worker = allWorkers.find(w => w.id === p.workerId);
    const workerName = worker ? worker.name : p.workerName || "‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶ï‡¶∞‡ßç‡¶Æ‡ßÄ";

    const modalWorkerSelect = document.getElementById("modalWorker");
    modalWorkerSelect.innerHTML = `<option value="${p.workerId}">${workerName}</option>`;
    
    disableEditMode(); 

    currentProductionData = {
        id: id,
        date: p.date,
        workerId: p.workerId,
        machine: p.machine,
        works: p.works || [],
    };
    
    renderWorksContainer(p.works, false);

    document.getElementById("modalDate").value = p.date;
    document.getElementById("modalMachine").value = p.machine;
    document.getElementById("modalGrandTotal").value = p.grandTotal;

    if (currentUserRole === "admin") {
        editDeleteButtons.classList.remove("hidden");
        document.getElementById("editButton").classList.remove("hidden");
        document.getElementById("updateButton").classList.add("hidden");
        document.getElementById("deleteButton").classList.add("hidden");
    } else {
        editDeleteButtons.classList.add("hidden");
    }

    document.getElementById("modal").classList.remove("hidden");
    document.getElementById("modal").classList.add("flex");
}

// üí° ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶Æ‡¶°‡¶æ‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
function renderWorksContainer(works, isEditable) {
    modalWorksContainer.innerHTML = "";
    
    works.forEach((w, index) => {
        const div = document.createElement("div");
        div.className = "work-entry border-b pb-2"; 
        
        div.innerHTML = `
          
          <div class="col-span-1">
          <label class="block text-gray-500 text-xs sm:hidden">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£/‡¶®‡¶æ‡¶Æ</label>
          <input type="text" data-field="product" value="${w.product || ''}" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" class="border rounded w-full modal-input" ${isEditable ? '' : 'disabled'}>
          </div>
          
          <div class="sm:col-span-1">
          <label class="block text-gray-500 text-xs sm:hidden">‡¶∏‡ßç‡¶ü‡¶ø‡¶ö (Stitch)</label>
          <input type="number" data-field="stage" value="${w.stage || 0}" placeholder="‡¶∏‡ßç‡¶ü‡¶ø‡¶ö" class="border rounded w-full modal-input" ${isEditable ? '' : 'disabled'} oninput="calculateModalTotal()">
          </div>
          
          <div class="sm:col-span-1">
          <label class="block text-gray-500 text-xs sm:hidden">‡¶¨‡ßç‡¶Ø‡¶æ‡¶∏ (Quantity)</label>
          <input type="number" data-field="count" value="${w.count || 0}" placeholder="‡¶¨‡ßç‡¶Ø‡¶æ‡¶∏" class="border rounded w-full modal-input" ${isEditable ? '' : 'disabled'} oninput="calculateModalTotal()">
          </div>
          
          <div class="sm:col-span-1">
          <label class="block text-gray-500 text-xs sm:hidden">‡¶Æ‡ßã‡¶ü (Total)</label>
          <input type="text" data-field="total" value="${w.total || 0}" placeholder="‡¶Æ‡ßã‡¶ü" class="border rounded w-full modal-input bg-gray-50" disabled>
          </div>
            
            <div class="flex justify-center items-center h-full col-span-2 sm:col-span-1">
            ${isEditable ? `
            <button type="button" 
            class="text-red-600 bg-red-100 hover:bg-red-200 border border-red-300 px-3 py-1 rounded-lg text-sm font-semibold flex items-center gap-1 transition duration-150" 
            onclick="removeWorkEntry(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
            </button>` 
            : '<div></div>'}
            </div>
        `;
        modalWorksContainer.appendChild(div);
    });

    if (isEditable) {
    const buttonContainer = document.createElement("div");
    buttonContainer.className = "flex justify-center pt-4"; 
    
    const addButton = document.createElement("button");
    addButton.type = "button";
    addButton.textContent = "+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®";
    
    addButton.className = "px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-semibold hover:bg-indigo-600 transition duration-150 shadow-md";
    
    addButton.onclick = addWorkEntry;
    
    buttonContainer.appendChild(addButton);
    modalWorksContainer.appendChild(buttonContainer);
    }
}

// üí° ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶° ‡¶∏‡¶ï‡ßç‡¶∑‡¶Æ ‡¶ï‡¶∞‡¶æ (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
window.enableEditMode = function() {
    document.getElementById("modalTitle").textContent = "‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
    
    document.getElementById("modalDate").disabled = false;
    document.getElementById("modalMachine").disabled = false;
    
    const modalWorkerSelect = document.getElementById("modalWorker");
    modalWorkerSelect.disabled = false;
    modalWorkerSelect.innerHTML = allWorkers.map(w => 
        `<option value="${w.id}" ${currentProductionData.workerId === w.id ? 'selected' : ''}>${w.name}</option>`
    ).join('');

    renderWorksContainer(currentProductionData.works, true);

    document.getElementById("editButton").classList.add("hidden");
    document.getElementById("updateButton").classList.remove("hidden");
    document.getElementById("deleteButton").classList.remove("hidden");
    
    calculateModalTotal();
}

function disableEditMode() {
    document.getElementById("modalDate").disabled = true;
    document.getElementById("modalMachine").disabled = true;
    document.getElementById("modalWorker").disabled = true;
}

// üí° ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
window.addWorkEntry = function() {
    const newWork = { product: '', stage: 0, count: 0, total: 0 };
    currentProductionData.works.push(newWork);
    renderWorksContainer(currentProductionData.works, true);
    calculateModalTotal();
}

// üí° ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
window.removeWorkEntry = function(buttonElement) {
    const entryDiv = buttonElement.closest('.work-entry');
    const allEntries = Array.from(modalWorksContainer.querySelectorAll('.work-entry'));
    const index = allEntries.indexOf(entryDiv);
    
    if (index > -1) {
        currentProductionData.works.splice(index, 1);
        renderWorksContainer(currentProductionData.works, true); 
        calculateModalTotal();
    }
}

// üí° ‡¶Æ‡ßã‡¶ü ‡¶∏‡ßç‡¶ü‡¶ø‡¶ö ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
window.calculateModalTotal = function() {
    let grandTotal = 0;
    const workEntries = modalWorksContainer.querySelectorAll('.work-entry');
    // üí° ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶Ü‡¶®‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ‡¶≤‡ßÅ‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá currentProductionData.works ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    currentProductionData.works = []; 

    workEntries.forEach((entry) => {
        const productInput = entry.querySelector('[data-field="product"]');
        const stageInput = entry.querySelector('[data-field="stage"]');
        const countInput = entry.querySelector('[data-field="count"]');
        const totalInput = entry.querySelector('[data-field="total"]');

        if (!productInput || !stageInput || !countInput || !totalInput) return; // ‡¶∏‡ßá‡¶´‡¶ü‡¶ø ‡¶ö‡ßá‡¶ï
        
        const product = productInput.value;
        const stage = parseFloat(stageInput.value) || 0;
        const count = parseFloat(countInput.value) || 0;
        
        const total = stage * count;
        
        totalInput.value = total.toFixed(0);
        grandTotal += total;
        
        currentProductionData.works.push({ product, stage, count, total });
    });
    
    document.getElementById("modalGrandTotal").value = grandTotal.toFixed(0);
}


// -----------------------------------------------------------------------
// üí° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü/‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞‡ßç‡¶∏ (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
// -----------------------------------------------------------------------

productionForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await updateProduction();
});


async function updateProduction() {
    loader.style.display = "flex";
    const docId = document.getElementById("modalProductionId").value;
    const newDate = document.getElementById("modalDate").value;
    const newWorkerId = document.getElementById("modalWorker").value;
    const newMachine = document.getElementById("modalMachine").value;
    const newGrandTotal = parseFloat(document.getElementById("modalGrandTotal").value);

    calculateModalTotal();
    const newWorks = currentProductionData.works;
    
    if (!docId || newWorks.length === 0) {
        alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!");
        loader.style.display = "none";
        return;
    }

    try {
        const productionRef = doc(db, "productions", docId);
        
        await updateDoc(productionRef, {
            date: newDate,
            workerId: newWorkerId,
            machine: newMachine,
            grandTotal: newGrandTotal.toString(),
            works: newWorks,
            lastUpdated: new Date().toISOString(),
        });

        alert("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
        closeModal();
        await fetchProductions();
    } catch (error) {
        console.error("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:", error);
        alert("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
    } finally {
        loader.style.display = "none";
    }
}

async function deleteProduction() {
    if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßÄ‡¶Ø‡¶º‡•§")) {
        return;
    }

    loader.style.display = "flex";
    const docId = document.getElementById("modalProductionId").value;
    
    try {
        await deleteDoc(doc(db, "productions", docId));
        
        alert("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
        closeModal();
        await fetchProductions();
    } catch (error) {
        console.error("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:", error);
        alert("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
    } finally {
        loader.style.display = "none";
    }
}

window.deleteProduction = deleteProduction;

// üîπ Close Modal (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
window.closeModal = function () {
    document.getElementById("modal").classList.add("hidden");
    document.getElementById("modal").classList.remove("flex");
    currentProductionData = null; 
}

// üîπ Setup Logout Button (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
function setupLogoutButton() {
    const logoutBtn = document.getElementById("logoutButton");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
            try {
                await signOut(auth);
                window.location.href = "login.html"; 
            } catch (error) {
                console.error("Logout Error:", error);
            }
        });
    }
}

// üîπ Auth State (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
onAuthStateChanged(auth, async user => {
¬† ¬† if (user) {
¬† ¬† ¬† ¬† if (typeof setupHeaderAndSidebar === "function") setupHeaderAndSidebar();
¬† ¬† ¬† ¬† setupLogoutButton();

¬† ¬† ¬† ¬† const userQuery = query(collection(db, "users"), where("email", "==", user.email));
¬† ¬† ¬† ¬† const userSnapshot = await getDocs(userQuery);
¬† ¬† ¬† ¬† if (!userSnapshot.empty) {
¬† ¬† ¬† ¬† ¬† ¬† const userData = userSnapshot.docs[0].data();
¬† ¬† ¬† ¬† ¬† ¬† currentUserRole = userData.role;
¬† ¬† ¬† ¬† ¬† ¬† if (currentUserRole === "admin") addStitchButton.classList.remove("hidden");
¬† ¬† ¬† ¬† ¬† ¬† else addStitchButton.classList.add("hidden");
¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† loadMonthYearFilters();
¬† ¬† ¬† ¬† await loadWorkers();¬†
¬† ¬† ¬† ¬† await fetchProductions();

¬† ¬† ¬† ¬† loader.style.display = "none";
¬† ¬† ¬† ¬† mainContent.classList.remove("hidden");
¬† ¬† ¬† ¬† lucide.createIcons();
¬† ¬† } else {
¬† ¬† ¬† ¬† window.location.href = "login.html";
¬† ¬† }
});

// üîπ Event Listeners (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á)
filterFrom.addEventListener("change", renderProductions);
filterTo.addEventListener("change", renderProductions);
filterMachine.addEventListener("change", renderProductions);
filterMonth.addEventListener("change", renderProductions);
filterYear.addEventListener("change", renderProductions);
filterWorker.addEventListener("change", async () => {
¬† ¬† await renderProductions();
});

clearFilter.addEventListener("click", () => {
¬† ¬† const now = new Date();
¬† ¬† filterFrom.value = "";
¬† ¬† filterTo.value = "";
¬† ¬† filterMachine.value = "";
¬† ¬† filterWorker.value = "";
¬† ¬† filterMonth.value = now.getMonth();
¬† ¬† filterYear.value = now.getFullYear();
¬† ¬† renderProductions();
});
</script>
</body>
</html>