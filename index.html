<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6 mt-12">
<div id="header-placeholder"></div>
<div id="loader" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
<div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-600"></div>
</div>

<div class="max-w-6xl mx-auto hidden" id="mainContent">

<div class="bg-white shadow-lg rounded-lg p-4 mb-6">
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4 justify-items-center">

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ</label>
<select id="filterWorker" class="border rounded p-2 w-full text-sm">
<option value="">‡¶∏‡¶¨</option>
</select>
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶Æ‡ßá‡¶∂‡¶ø‡¶®</label>
<select id="filterMachine" class="border rounded p-2 w-full text-sm">
<option value="">‡¶∏‡¶¨</option>
</select>
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶Æ‡¶æ‡¶∏</label>
<select id="filterMonth" class="border rounded p-2 w-full text-sm"></select>
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶¨‡¶õ‡¶∞</label>
<select id="filterYear" class="border rounded p-2 w-full text-sm"></select>
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶•‡ßá‡¶ï‡ßá</label>
<input type="date" id="filterFrom" class="border rounded p-2 w-full text-sm">
</div>

<div class="w-full max-w-[140px]">
<label class="block text-gray-600 mb-1 text-sm">‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§</label>
<input type="date" id="filterTo" class="border rounded p-2 w-full text-sm">
</div>

<div class="w-full max-w-[140px] flex justify-center items-end">
<button id="clearFilter" class="px-3 py-2 bg-gray-300 rounded hover:bg-gray-400 w-full text-sm">
‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
</button>
</div>

<div class="w-full max-w-[140px] flex justify-center items-end hidden" id="addStitchButton">
<a href="add-stitch.html" class="px-3 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 w-full text-sm text-center">
‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
</a>
</div>

</div>
</div>

<div id="summaryCards" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
<div id="totalProductionCard" class="bg-white shadow rounded p-4 text-center">
<h3 class="text-gray-500 text-sm">‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®</h3>
<p id="totalProductionValue" class="text-2xl font-bold text-indigo-700">0</p>

</div>
<div id="averageProductionCard" class="bg-white shadow rounded p-4 text-center">
<h3 class="text-gray-500 text-sm">‡¶ó‡¶°‡¶º ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®</h3>
<p id="averageProductionValue" class="text-2xl font-bold text-green-600">0</p>
</div>

<div id="workdayProductionCard" class="bg-white shadow rounded p-4 text-center">
<h3 class="text-gray-500 text-sm">‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®</h3>
<p id="workdayProductionValue" class="text-2xl font-bold text-indigo-700">0</p>

</div>
<div id="targetProductionCard" class="bg-white shadow rounded p-4 text-center">
<h3 class="text-gray-500 text-sm">‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®</h3>
<p id="targetProductionValue" class="text-2xl font-bold text-green-600">0</p>
</div>
</div>

<div class="bg-white shadow-lg rounded-lg p-6 text-center">

<h2 class="text-xl font-bold text-indigo-700 mb-4 text-center" id="tableTitle">üìã ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>

<div class="overflow-x-auto">

<table class="w-full border table-auto">

<thead>

<tr class="bg-gray-200 text-left text-sm">

<th class="p-2 border whitespace-nowrap">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>

<th class="p-2 border whitespace-nowrap">‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ</th>

<th class="p-2 border whitespace-nowrap">‡¶Æ‡ßá‡¶∂‡¶ø‡¶®</th>

<th class="p-2 border whitespace-nowrap">‡¶Æ‡ßã‡¶ü ‡¶∏‡ßç‡¶ü‡¶ø‡¶ö</th>

<th class="p-2 border whitespace-nowrap">‡¶ó‡¶°‡¶º ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶®</th>

<th class="p-2 border whitespace-nowrap">‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï</th>

<th class="p-2 border whitespace-nowrap">‡¶ï‡¶∞‡ßç‡¶Æ</th>

</tr>

</thead>

<tbody id="productionList" class="text-sm"></tbody>

</table>

</div>

</div>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">

<div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg overflow-y-auto max-h-[80vh]">

<h3 class="text-lg font-bold mb-4">‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>

<div id="modalContent" class="space-y-2"></div>

<div class="text-right mt-4">

<button onclick="closeModal()" class="px-4 py-2 bg-red-500 text-white rounded">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>

</div>

</div>

</div>

</div>

<div id="footer-placeholder"></div>
<script src="include-loader.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCdVxsSPUirznH-67MoHln3kdyPS1SMB94",
        authDomain: "asembroidery-5cd5e.firebaseapp.com",
        projectId: "asembroidery-5cd5e",
        storageBucket: "asembroidery-5cd5e.appspot.com",
        messagingSenderId: "592758047307",
        appId: "1:592758047307:web:d4f7d69bcd9f0398ac83ce"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const productionList = document.getElementById("productionList");
    const filterFrom = document.getElementById("filterFrom");
    const filterTo = document.getElementById("filterTo");
    const filterMachine = document.getElementById("filterMachine");
    const filterWorker = document.getElementById("filterWorker");
    const filterMonth = document.getElementById("filterMonth");
    const filterYear = document.getElementById("filterYear");
    const clearFilter = document.getElementById("clearFilter");
    const tableTitle = document.getElementById("tableTitle");
    const loader = document.getElementById("loader");
    const mainContent = document.getElementById("mainContent");
    const addStitchButton = document.getElementById("addStitchButton");
    const targetProductionValue = document.getElementById("targetProductionValue");

    const monthNames = ["‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];

    let allProductions = [];
    let allWorkers = [];
    let defaultAdminTarget = "0"; 

    async function loadWorkers() {
        // Dropdown ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        filterWorker.innerHTML = `<option value="">‡¶∏‡¶¨</option>`;
        
        allWorkers = [];
        const q = query(collection(db, "users"), where("role", "==", "user"));
        const snapshot = await getDocs(q);
        snapshot.forEach(docSnap => {
            const user = docSnap.data();
            user.id = docSnap.id;
            allWorkers.push(user);
            const opt = document.createElement("option");
            opt.value = docSnap.id;
            opt.textContent = user.name;
            filterWorker.appendChild(opt);
        });
    }

    function loadMonthYearFilters() {
        const now = new Date();
        monthNames.forEach((name, i) => {
            const opt = document.createElement("option");
            opt.value = i;
            opt.text = name;
            filterMonth.appendChild(opt);
        });
        filterMonth.value = now.getMonth();
        for (let y = now.getFullYear(); y >= now.getFullYear() - 3; y--) {
            const opt = document.createElement("option");
            opt.value = y;
            opt.text = y;
            filterYear.appendChild(opt);
        }
        filterYear.value = now.getFullYear();
    }

    function populateMachines(productions) {
        const machines = [...new Set(productions.map(p => p.machine))];
        filterMachine.innerHTML = `<option value="">‡¶∏‡¶¨</option>`;
        machines.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            filterMachine.appendChild(opt);
        });
    }

    async function fetchProductions() {
        loader.style.display = "flex";
        try {
            const q = query(collection(db, "productions"), orderBy("date", "desc"));
            const snapshot = await getDocs(q);
            allProductions = [];
            snapshot.forEach(docSnap => {
                let p = docSnap.data();
                p.id = docSnap.id;
                allProductions.push(p);
            });
            populateMachines(allProductions);
            renderProductions();
        } catch (err) {
            console.error("Firebase ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ", err);
            productionList.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</td></tr>`;
        } finally {
            loader.style.display = "none";
            mainContent.classList.remove("hidden");
        }
    }

    async function setTargetValue(workerId) {
        if (workerId) {
            const worker = allWorkers.find(w => w.id === workerId);
            targetProductionValue.textContent = (worker && worker.target) ? worker.target : "0";
        } else {
            targetProductionValue.textContent = defaultAdminTarget;
        }
    }

    async function renderProductions() {
        productionList.innerHTML = "";
        const monthFilter = filterMonth.value !== "" ? parseInt(filterMonth.value) : null;
        const yearFilter = filterYear.value !== "" ? parseInt(filterYear.value) : null;
        const startDate = filterFrom.value ? new Date(filterFrom.value + "T00:00:00") : null;
        const endDate = filterTo.value ? new Date(filterTo.value + "T23:59:59") : null;
        const machineFilter = filterMachine.value;
        const workerFilter = filterWorker.value;

        const filtered = allProductions
            .filter(p => {
                const dateObj = new Date(p.date);
                if (monthFilter !== null && dateObj.getMonth() !== monthFilter) return false;
                if (yearFilter !== null && dateObj.getFullYear() !== yearFilter) return false;
                if (startDate && dateObj < startDate) return false;
                if (endDate && dateObj > endDate) return false;
                if (machineFilter && p.machine !== machineFilter) return false;
                if (workerFilter && p.workerId !== workerFilter) return false;
                return true;
            });

        const monthName = monthFilter !== null ? monthNames[monthFilter] : "‡¶∏‡¶¨ ‡¶Æ‡¶æ‡¶∏";
        tableTitle.textContent = `üìã ${monthName} ¬∑ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡¶∂‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü`;

        const groupedData = filtered.reduce((acc, p) => {
            const dateKey = new Date(p.date).toISOString().split('T')[0];
            const workerKey = p.workerId;
            const uniqueKey = `${workerKey}-${dateKey}`;

            if (!acc[uniqueKey]) {
                acc[uniqueKey] = {
                    ...p,
                    date: dateKey,
                    grandTotal: parseFloat(p.grandTotal),
                    works: [...p.works],
                    id: p.id
                };
            } else {
                acc[uniqueKey].grandTotal += parseFloat(p.grandTotal);
                acc[uniqueKey].works.push(...p.works);
            }
            return acc;
        }, {});

        const groupedArray = Object.values(groupedData);

        if (groupedArray.length === 0) {
            productionList.innerHTML = `<tr><td colspan="7" class="text-center py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>`;
            document.getElementById("totalProductionValue").textContent = "0";
            document.getElementById("averageProductionValue").textContent = "0";
            document.getElementById("workdayProductionValue").textContent = "0";
            return;
        }

        const monthlyTotals = groupedArray
            .reduce((acc, p) => {
                if (!acc[p.workerId]) acc[p.workerId] = { total: 0, count: 0 };
                acc[p.workerId].total += p.grandTotal;
                acc[p.workerId].count++;
                return acc;
            }, {});

        const monthlyRanking = Object.entries(monthlyTotals)
            .sort(([, a], [, b]) => b.total - a.total)
            .map(([workerId, data], index) => ({ workerId, rank: index + 1 }));

        let rankMap = {};
        monthlyRanking.forEach(r => rankMap[r.workerId] = r.rank);

        let cumulativeTotals = {};
        let cumulativeCounts = {};
        let prevAverages = {};
        let prevGrandTotals = {};

        const sortedByDate = [...groupedArray].sort((a, b) => new Date(a.date) - new Date(b.date));

        sortedByDate.forEach(p => {
            const wid = p.workerId;
            const grandTotal = p.grandTotal;

            if (!cumulativeTotals[wid]) cumulativeTotals[wid] = 0;
            if (!cumulativeCounts[wid]) cumulativeCounts[wid] = 0;

            cumulativeTotals[wid] += grandTotal;
            cumulativeCounts[wid]++;
            const avg = (cumulativeTotals[wid] / cumulativeCounts[wid]).toFixed(2);

            let avgColorClass = "";
            if (prevAverages[wid] !== undefined) {
                if (parseFloat(avg) > parseFloat(prevAverages[wid])) avgColorClass = "text-green-600 font-bold";
                else if (parseFloat(avg) < parseFloat(prevAverages[wid])) avgColorClass = "text-red-600 font-bold";
            }
            prevAverages[wid] = avg;

            let totalColorClass = "";
            if (prevGrandTotals[wid] !== undefined) {
                if (grandTotal > prevGrandTotals[wid]) totalColorClass = "text-green-600 font-bold";
                else if (grandTotal < prevGrandTotals[wid]) totalColorClass = "text-red-600 font-bold";
            }
            prevGrandTotals[wid] = grandTotal;

            p.cumulativeAvg = avg;
            p.avgColorClass = avgColorClass;
            p.totalColorClass = totalColorClass;
        });

        const sortedForDisplay = sortedByDate.sort((a, b) => new Date(b.date) - new Date(a.date));

        sortedForDisplay.forEach(p => {
            const tr = document.createElement("tr");
            const date = new Date(p.date);
            const formattedDate = date.toLocaleDateString('bn-BD');

            tr.innerHTML = `
                <td class="p-2 border">${formattedDate}</td>
                <td class="p-2 border">${p.workerName}</td>
                <td class="p-2 border">${p.machine}</td>
                <td class="p-2 border ${p.totalColorClass}">${p.grandTotal}</td>
                <td class="p-2 border ${p.avgColorClass}">${p.cumulativeAvg}</td>
                <td class="p-2 border font-bold">${rankMap[p.workerId] || '-'}</td>
                <td class="p-2 border">
                    <button onclick="viewProduction('${p.id}')" class="text-indigo-600 underline">‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                </td>
            `;
            productionList.appendChild(tr);
        });

        let totalProduction = groupedArray.reduce((sum, p) => sum + p.grandTotal, 0);
        let totalWorkdays = groupedArray.length;
        let averageProduction = 0;
        if (totalWorkdays > 0) {
            averageProduction = (totalProduction / totalWorkdays).toFixed(2);
        }

        document.getElementById("totalProductionValue").textContent = totalProduction;
        document.getElementById("averageProductionValue").textContent = averageProduction;
        document.getElementById("workdayProductionValue").textContent = totalWorkdays;
        
    }

    window.viewProduction = async function (id) {
        const production = allProductions.find(p => p.id === id);

        if (production) {
            document.getElementById("modalContent").innerHTML = `
                <p><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${new Date(production.date).toLocaleString('bn-BD')}</p>
                <p><strong>‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ:</strong> ${production.workerName}</p>
                <p><strong>‡¶Æ‡ßá‡¶∂‡¶ø‡¶®:</strong> ${production.machine}</p>
                <p><strong>‡¶Æ‡ßã‡¶ü ‡¶∏‡ßç‡¶ü‡¶ø‡¶ö:</strong> ${production.grandTotal}</p>
                <hr class="my-2">
                <h4 class="font-bold">‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§:</h4>
                ${production.works.map(w => `
                    <div class="border p-2 mb-2 rounded">
                        <p>‡¶™‡¶£‡ßç‡¶Ø: ${w.product}</p>
                        <p>‡¶™‡¶∞‡ßç‡¶¨: ${w.stage}</p>
                        <p>‡¶ó‡¶£‡¶®‡¶æ: ${w.count}</p>
                        <p>‡¶Æ‡ßã‡¶ü: ${w.total}</p>
                    </div>
                `).join("")}
            `;
            document.getElementById("modal").classList.remove("hidden");
            document.getElementById("modal").classList.add("flex");
        } else {
            const docSnap = await getDoc(doc(db, "productions", id));
            if (docSnap.exists()) {
                const p = docSnap.data();
                document.getElementById("modalContent").innerHTML = `
                    <p><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${new Date(p.date).toLocaleString('bn-BD')}</p>
                    <p><strong>‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ:</strong> ${p.workerName}</p>
                    <p><strong>‡¶Æ‡ßá‡¶∂‡¶ø‡¶®:</strong> ${p.machine}</p>
                    <p><strong>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶∏‡ßç‡¶ü‡¶ø‡¶ö:</strong> ${p.grandTotal}</p>
                    <hr class="my-2">
                    <h4 class="font-bold">‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§:</h4>
                    ${p.works.map(w => `
                        <div class="border p-2 mb-2 rounded">
                            <p>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£: ${w.product}</p>
                            <p>‡¶∏‡ßç‡¶ü‡¶ø‡¶ö: ${w.stage}</p>
                            <p>‡¶¨‡ßá‡¶∏: ${w.count}</p>
                            <p>‡¶Æ‡ßã‡¶ü: ${w.total}</p>
                        </div>
                    `).join("")}
                `;
                document.getElementById("modal").classList.remove("hidden");
                document.getElementById("modal").classList.add("flex");
            }
        }
    }

    window.closeModal = function () {
        document.getElementById("modal").classList.add("hidden");
        document.getElementById("modal").classList.remove("flex");
    }
    
    // Auth state changes
    onAuthStateChanged(auth, async user => {
        if (user) {
            await includeHTML("header.html", "header-placeholder");
            await includeHTML("footer.html", "footer-placeholder");
            setupHeaderAndSidebar();
            
            const adminQuery = query(collection(db, "users"), where("role", "==", "admin"));
            const adminSnapshot = await getDocs(adminQuery);
            if (!adminSnapshot.empty) {
                defaultAdminTarget = adminSnapshot.docs[0].data().target || "0";
            }
            
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().role === "admin") {
                addStitchButton.classList.remove("hidden");
            } else {
                addStitchButton.classList.add("hidden");
            }

            loadMonthYearFilters();
            await loadWorkers();
            await fetchProductions();
            setTargetValue(null);
            
            loader.style.display = "none";
            mainContent.classList.remove("hidden");
            lucide.createIcons();

        } else {
            window.location.href = "login.html";
        }
    });

    // Event listeners
    filterFrom.addEventListener("change", renderProductions);
    filterTo.addEventListener("change", renderProductions);
    filterMachine.addEventListener("change", renderProductions);
    filterMonth.addEventListener("change", renderProductions);
    filterYear.addEventListener("change", renderProductions);
    
    filterWorker.addEventListener("change", async () => {
        await renderProductions();
        await setTargetValue(filterWorker.value);
    });
    
    clearFilter.addEventListener("click", () => {
        const now = new Date();
        filterFrom.value = "";
        filterTo.value = "";
        filterMachine.value = "";
        filterWorker.value = "";
        filterMonth.value = now.getMonth();
        filterYear.value = now.getFullYear();
        setTargetValue(null);
        renderProductions();
    });
</script>
</body>
</html>