<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ওয়ার্কার প্রোডাকশন</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body { display: none; }
  /* নতুন CSS: এডিট আইকনকে বাটন থেকে আইকনে পরিণত করা */
  #editTargetBtn {
    background: none;
    border: none;
    padding: 0;
    margin-left: 0.5rem; /* টাইটেল থেকে সামান্য দূরত্ব */
    color: #4f46e5; /* Tailwind indigo-600 */
    cursor: pointer;
    transition: color 0.2s;
  }
  #editTargetBtn:hover {
    color: #3730a3; /* Tailwind indigo-800 */
  }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

<div id="loader" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
  <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-600"></div>
</div>

<div class="bg-white shadow-lg rounded-lg p-6 w-full max-w-3xl mb-6" id="mainContent">

<div class="flex items-center justify-center mb-6 space-x-3">
  <div class="flex items-center space-x-2">
    <i data-lucide="plus-circle" class="w-5 h-5 text-indigo-700"></i>
    <h1 class="text-2xl font-bold text-indigo-700 whitespace-nowrap">Add Production</h1>
  </div>
  <button type="button" id="editTargetBtn" title="প্রোডাকশন টার্গেট ও বেতন সেট করুন" class="text-indigo-700 hover:text-indigo-900">
    <i data-lucide="edit" class="w-5 h-5"></i>
  </button>
</div>


<form id="productionForm" class="space-y-4 hidden">

  <div class="grid grid-cols-2 gap-4">
    <div>
        <label class="block text-gray-600 mb-1 text-center">তারিখ</label>
        <input type="date" id="date" class="w-full border rounded p-2" required>
    </div>
    <div class="w-full">
    <label class="block text-gray-600 mb-1 text-center">ওয়ার্কার</label>
    <select id="worker" class="w-full border rounded p-2 text-center" required>
    <option value="">ওয়ার্কার</option>
    </select>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-4">
    <div>
      <label class="block text-gray-600 mb-1 text-center">মিশিন</label>
      <select id="machine" class="w-full border rounded p-2 text-center" required>
        <option value="All">মিশিন</option>
        <option value="M1">M1</option>
        <option value="M2">M2</option>
        <option value="M3">M3</option>
        <option value="M4">M4</option>
      </select>
    </div>
    <div>
    <label class="block text-gray-600 mb-1 text-center">বন্ধের সময়</label>
    <input type="text" id="stopTime" class="w-full border rounded p-2 text-center" placeholder="HH:MM (যেমন: 02:00)" value="00:00" required>
    </div>
  </div>

  <div class="text-gray-600 font-semibold mb-2 text-center">কাজের বিবরণ</div>
  <div id="stageContainer" class="flex flex-col gap-4"></div>

  <div class="text-center font-bold text-lg text-green-700 mt-4">
    সর্বমোট: <span id="grandTotal">0</span>
  </div>

  <div>
      <label for="notes" class="block text-gray-600 mb-1 text-center">নোট / মন্তব্য</label>
      <textarea id="notes" class="w-full border rounded p-2" rows="2" placeholder="যেমন: লোডশেডিং এর জন্য ২ ঘন্টা বন্ধ ছিল।"></textarea>
  </div>
  <div>
    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 w-full">সংরক্ষণ করুন</button>
  </div>
</form>

<p id="accessDenied" class="text-red-600 text-center mt-4 hidden">❌ Only admin can access this page.</p>
</div>

<div id="targetModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
    <h2 class="text-xl font-bold text-indigo-700 mb-4">টার্গেট ও বেতন আপডেট</h2>
    
    <div class="space-y-4">
        <div>
          <label for="targetWorkerSelect" class="block text-gray-600 mb-1">ওয়ার্কার নির্বাচন করুন</label>
          <select id="targetWorkerSelect" class="w-full border rounded p-2 text-center">
            <option value="">ওয়ার্কার</option>
          </select>
        </div>
        <div id="targetInputContainer" class="hidden space-y-4">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="targetMachineSelect" class="block text-gray-600 mb-1 text-sm">নির্ধারিত মেশিন</label>
                    <select id="targetMachineSelect" class="w-full border rounded p-2 text-center text-sm">
                        <option value="All">মিশিন</option>
                        <option value="M1">M1</option>
                        <option value="M2">M2</option>
                        <option value="M3">M3</option>
                        <option value="M4">M4</option>
                    </select>
                </div>
                
                <div>
                    <label for="fixedProduction" class="block text-gray-600 mb-1 text-sm">নির্ধারিত প্রোডাকশন (বেস)</label>
                    <input type="number" id="fixedProduction" class="w-full border rounded p-2 text-sm" placeholder="যেমন: 500" step="1">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="productionTarget" class="block text-gray-600 mb-1 text-sm">টার্গেট প্রোডাকশন</label>
                    <input type="number" id="productionTarget" class="w-full border rounded p-2 text-sm" placeholder="যেমন: 5000" step="1">
                </div>

                <div>
                    <label for="fixedSalary" class="block text-gray-600 mb-1 text-sm">নির্ধারিত বেতন (টাকা)</label>
                    <input type="number" id="fixedSalary" class="w-full border rounded p-2 text-sm" placeholder="যেমন: 15000" step="100">
                </div>
            </div>
            
            <div class="p-3 bg-indigo-50 border border-indigo-200 rounded text-center">
                <label class="block text-gray-700 font-semibold mb-1">প্রাপ্য বেতন (অনুমান)</label>
                <div id="achievedSalaryDisplay" class="text-xl font-bold text-indigo-700">৳ 0.00</div>
                <div id="achievedPercentage" class="text-sm text-gray-500">০% টার্গেট পূরণ</div>
            </div>
            </div>
    </div>
    
    <div class="mt-6 flex justify-end space-x-3">
      <button type="button" id="closeModalBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">বাতিল</button>
      <button type="button" id="saveTargetBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400" disabled>আপডেট করুন</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdVxsSPUirznH-67MoHln3kdyPS1SMB94",
  authDomain: "asembroidery-5cd5e.firebaseapp.com",
  projectId: "asembroidery-5cd5e",
  storageBucket: "asembroidery-5cd5e.appspot.com",
  messagingSenderId: "592758047307",
  appId: "1:592758047307:web:d4f7d69bcd9f0398ac83ce"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const WORKER_CATEGORY_KEY = "6TeDHhrINuMH5SxU6dAr";

const productionForm = document.getElementById("productionForm");
const workerSelect = document.getElementById("worker");
const machineSelect = document.getElementById("machine"); 
const stageContainer = document.getElementById("stageContainer");
const grandTotalSpan = document.getElementById("grandTotal");
const loader = document.getElementById("loader");

// Modal উপাদান
const targetModal = document.getElementById("targetModal");
const editTargetBtn = document.getElementById("editTargetBtn");
const closeModalBtn = document.getElementById("closeModalBtn");
const targetWorkerSelect = document.getElementById("targetWorkerSelect");
const targetMachineSelect = document.getElementById("targetMachineSelect");
const fixedProductionInput = document.getElementById("fixedProduction");
const productionTargetInput = document.getElementById("productionTarget");
const fixedSalaryInput = document.getElementById("fixedSalary");
const targetInputContainer = document.getElementById("targetInputContainer");
const saveTargetBtn = document.getElementById("saveTargetBtn");

// নতুন ডিসপ্লে উপাদান
const achievedSalaryDisplay = document.getElementById("achievedSalaryDisplay");
const achievedPercentage = document.getElementById("achievedPercentage");

// **********************************************
// বন্ধের সময় (Stop Time) এবং নোট উপাদান
// **********************************************
const stopTimeInput = document.getElementById("stopTime"); // ID: stopTime
const notesInput = document.getElementById("notes"); // নোট
// **********************************************

let authChecked = false;

// Product/বিবরণ আইটেমগুলির লিস্ট (No Change)
const PRODUCT_LIST = [
    "বডি",
    "পেনেল/ঘের",
    "গলা/কলার",
    "হাতা",
    "ওড়না",
    "সেলোয়ার",
    "টাই/লেস",
    "মনোগ্রাম/লোগো",
    "অন্যান্য"
];

// Create Work Row (No Change)
function createRow() {
  const row = document.createElement("div");
  row.className = "border rounded p-2 flex flex-col gap-2";

  // ড্রপডাউন অপশন তৈরি করা
  let productOptions = '<option value="">বিবরণ নির্বাচন করুন</option>';
  PRODUCT_LIST.forEach(item => {
      productOptions += `<option value="${item}">${item}</option>`;
  });
  
  row.innerHTML = `
    <div class="flex flex-wrap gap-2">
      <select class="product border rounded p-2 flex-1 min-w-[45%]" required>
          ${productOptions}
      </select>
      <input type="number" class="stage border rounded p-2 flex-1 min-w-[45%]" placeholder="স্টিজ" step="1" required>
    </div>
    <div class="flex flex-wrap gap-2">
      <input type="number" class="count border rounded p-2 flex-1 min-w-[45%]" placeholder="বেস" step="0.1" required>
      <input type="text" class="total border rounded p-2 bg-gray-100 flex-1 min-w-[45%]" placeholder="মোট" readonly>
    </div>
    <div class="flex gap-2 justify-center">
      <button type="button" class="remove px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 flex items-center justify-center">
        <i data-lucide="x-circle" class="w-5 h-5 mr-1"></i> মুছুন
      </button>
      <button type="button" class="addRowBtn px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 flex items-center justify-center">
        <i data-lucide="plus-circle" class="w-5 h-5 mr-1"></i>
        যুক্ত করুন
      </button>
    </div>
  `;

  stageContainer.appendChild(row);
  lucide.createIcons();

  const stageInput = row.querySelector(".stage");
  const countInput = row.querySelector(".count");
  const totalInput = row.querySelector(".total");
  const removeBtn = row.querySelector(".remove");
  const addRowBtn = row.querySelector(".addRowBtn");

  function calculateRow() {
    const stage = parseFloat(stageInput.value) || 0;
    const count = parseFloat(countInput.value) || 0;
    totalInput.value = (stage * count).toFixed(2);
    calculateGrandTotal();
  }

  stageInput.addEventListener("input", calculateRow);
  countInput.addEventListener("input", calculateRow);

  removeBtn.addEventListener("click", () => { row.remove(); calculateGrandTotal(); });
  addRowBtn.addEventListener("click", createRow);
}

// Grand Total Calculation (No Change)
function calculateGrandTotal() {
  let sum = 0;
  document.querySelectorAll("#stageContainer > div").forEach(row => {
    const stage = parseFloat(row.querySelector(".stage").value) || 0;
    const count = parseFloat(row.querySelector(".count").value) || 0;
    sum += (stage * count);
  });
  grandTotalSpan.textContent = sum.toFixed(2);
}

createRow();

// Load Users for both main form and modal (No Change)
async function loadUsers(targetSelectElement) {
  const peopleRef = collection(db, "people");
  const q = query(peopleRef, where("category_key", "==", WORKER_CATEGORY_KEY)); 
  
  const snapshot = await getDocs(q);
  
  targetSelectElement.innerHTML = '<option value="">ওয়ার্কার</option>';
  
  snapshot.forEach(docSnap => {
    const user = docSnap.data();
    const opt = document.createElement("option");
    
    opt.value = docSnap.id; 
    opt.textContent = user.name;
    
    // ডেটা-অ্যাট্রিবিউট এ সেভ করা হচ্ছে
    if (user.fixedProduction) {
        opt.dataset.fixed = user.fixedProduction;
    }
    if (user.productionTarget) {
        opt.dataset.target = user.productionTarget;
    }
    // fixedSalary এর জন্য একটি নতুন ডাটা-এট্রিবিউট প্রয়োজন
    if (user.fixedSalary) { 
        opt.dataset.fixedsalary = user.fixedSalary; 
    }
    if (user.achievedSalary) {
        opt.dataset.salary = user.achievedSalary; 
    }
    if (user.achievedPercentage) {
        opt.dataset.percentage = user.achievedPercentage; 
    }
    // --- অ্যাসাইন করা মেশিন সেভ করা ---
    if (user.assignedMachine) {
        opt.dataset.machine = user.assignedMachine;
    }
    // ----------------------------------------
    
    targetSelectElement.appendChild(opt);
  });
}

// =========================================================
// প্রাপ্য বেতন গণনার ফাংশন (No Change)
// =========================================================
function calculateAchievedSalary(fixedProd, targetProd, fixedSal) {
    const fixedProduction = parseFloat(fixedProd) || 0; // বেস বা স্ট্যান্ডার্ড
    const productionTarget = parseFloat(targetProd) || 0; // ওয়ার্কারের পারফরম্যান্স
    const fixedSalary = parseFloat(fixedSal) || 0; // নির্ধারিত বেতন

    let achievedSalary = 0;
    let actualPercentage = 0;

    if (fixedProduction > 0) {
        // ১. শতাংশ গণনা: (টার্গেট প্রোডাকশন / নির্ধারিত প্রোডাকশন) * 100
        actualPercentage = (productionTarget / fixedProduction) * 100;
        
        // ২. প্রাপ্য বেতন গণনা: নির্ধারিত বেতনের তত শতাংশ
        achievedSalary = fixedSalary * (actualPercentage / 100);
    }
    
    // ডিসপ্লে আপডেট
    achievedSalaryDisplay.textContent = `৳ ${achievedSalary.toFixed(2)}`;
    achievedPercentage.textContent = `${actualPercentage.toFixed(0)}% টার্গেট পূরণ`;

    // সেভ করার জন্য মানগুলো রিটার্ন করা
    return {
        achievedSalary: achievedSalary.toFixed(2), 
        actualPercentage: actualPercentage.toFixed(2)
    };
}

// ইনপুট পরিবর্তন হলে প্রাপ্য বেতন গণনা করা (No Change)
fixedProductionInput.addEventListener('input', () => {
    calculateAchievedSalary(fixedProductionInput.value, productionTargetInput.value, fixedSalaryInput.value);
});
productionTargetInput.addEventListener('input', () => {
    calculateAchievedSalary(fixedProductionInput.value, productionTargetInput.value, fixedSalaryInput.value);
});
fixedSalaryInput.addEventListener('input', () => {
    calculateAchievedSalary(fixedProductionInput.value, productionTargetInput.value, fixedSalaryInput.value);
});

// =========================================================
// ১. প্রধান ফর্মে ওয়ার্কার পরিবর্তনের লজিক (মেশিন অটো-ফিল্টার) - No Change
// =========================================================
workerSelect.addEventListener('change', (e) => {
    const workerId = e.target.value;

    if (workerId) {
        const selectedOption = workerSelect.options[workerSelect.selectedIndex];
        const assignedMachine = selectedOption.dataset.machine || 'All'; 
        
        machineSelect.value = assignedMachine;
    } else {
        machineSelect.value = 'All';
    }
});

// =========================================================
// টার্গেট ও বেতন আপডেট লজিক (Modal-এর জন্য) - No Change
// =========================================================

// Modal ওপেন করা (No Change)
editTargetBtn.addEventListener('click', () => {
    loadUsers(targetWorkerSelect);
    targetModal.style.display = 'flex';
    // ইনপুট খালি করা ও ডিফল্ট সেট করা
    targetMachineSelect.value = 'All'; 
    fixedProductionInput.value = '';
    productionTargetInput.value = '';
    fixedSalaryInput.value = ''; 
    
    achievedSalaryDisplay.textContent = `৳ 0.00`;
    achievedPercentage.textContent = `০% টার্গেট পূরণ`;

    targetInputContainer.classList.add("hidden");
    saveTargetBtn.disabled = true;
});

// Modal বন্ধ করা (No Change)
closeModalBtn.addEventListener('click', () => {
    targetModal.style.display = 'none';
});

// ওয়ার্কার নির্বাচন করলে টার্গেট, বেতন এবং মেশিন দেখানো (No Change)
targetWorkerSelect.addEventListener('change', async (e) => {
    const workerId = e.target.value;
    
    if (workerId) {
        targetInputContainer.classList.remove("hidden");
        saveTargetBtn.disabled = false;
        
        const selectedOption = targetWorkerSelect.options[targetWorkerSelect.selectedIndex];
        
        // --- ডেটা লোড করে ইনপুটে সেট করা ---
        const currentFixed = selectedOption.dataset.fixed || '';
        const currentTarget = selectedOption.dataset.target || '';
        const currentFixedSalary = selectedOption.dataset.fixedsalary || ''; 
        const currentMachine = selectedOption.dataset.machine || 'All'; 

        targetMachineSelect.value = currentMachine; // মেশিনের মান সেট করা
        fixedProductionInput.value = currentFixed;
        productionTargetInput.value = currentTarget;
        fixedSalaryInput.value = currentFixedSalary; // ফিক্সড স্যালারি ইনপুট ফিল্ডে লোড করা

        // ডেটা লোড হওয়ার পর প্রাপ্য বেতন গণনা
        calculateAchievedSalary(currentFixed, currentTarget, currentFixedSalary); 

    } else {
        targetInputContainer.classList.add("hidden");
        saveTargetBtn.disabled = true;
    }
});

// টার্গেট ও বেতন ফায়ারস্টোরে আপডেট করা (No Change)
saveTargetBtn.addEventListener('click', async () => {
    const workerId = targetWorkerSelect.value;
    const assignedMachine = targetMachineSelect.value; 
    const fixedValue = parseFloat(fixedProductionInput.value) || 0;
    const targetValue = parseFloat(productionTargetInput.value) || 0;
    const salaryValue = parseFloat(fixedSalaryInput.value) || 0; // ফিক্সড স্যালারি ইনপুট থেকে নেওয়া হলো

    if (!workerId || fixedValue < 0 || targetValue < 0 || salaryValue < 0) {
        Swal.fire('ত্রুটি','বৈধ মান দিন।','error');
        return;
    }

    // প্রাপ্য বেতনের চূড়ান্ত মান গণনা
    const result = calculateAchievedSalary(fixedValue, targetValue, salaryValue);


    try {
        const workerDocRef = doc(db, "people", workerId);
        
        await updateDoc(workerDocRef, {
            assignedMachine: assignedMachine, 
            fixedProduction: fixedValue,
            productionTarget: targetValue,
            fixedSalary: salaryValue, // ফিক্সড স্যালারি ডাটাবেসে সেভ করা দরকার
            achievedSalary: result.achievedSalary, // নতুন ফিল্ড: প্রাপ্য বেতন সেভ করা হচ্ছে
            achievedPercentage: result.actualPercentage // নতুন ফিল্ড: শতাংশ সেভ করা হচ্ছে
        });

        Swal.fire('সংরক্ষিত!','টার্গেট, বেতন ও মেশিন সফলভাবে আপডেট হয়েছে।','success');
        
        // উভয় ড্রপডাউন রিফ্রেশ করা
        await loadUsers(workerSelect); 
        targetModal.style.display = 'none';

    } catch (err) {
        console.error(err);
        Swal.fire('ত্রুটি','টার্গেট ও বেতন আপডেট করা যায়নি।','error');
    }
});

// =========================================================
// Save Production (আপডেট: stopTime সেভ করা) - ID পরিবর্তন করা হয়েছে
// =========================================================
productionForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const submitButton = productionForm.querySelector('button[type="submit"]');
  
  let incomplete = false;
  const works = [];
  document.querySelectorAll("#stageContainer > div").forEach(row => {
    const product = row.querySelector(".product").value; 
    const stage = row.querySelector(".stage").value;
    const count = row.querySelector(".count").value;
    if (!product || !stage || !count) {
      incomplete = true;
      return;
    }
    works.push({
      product, stage, count,
      total: row.querySelector(".total").value
    });
  });
  
  // প্রয়োজনীয় ইনপুট ভ্যালু চেক করা
  if (!workerSelect.value || !document.getElementById("machine").value || !document.getElementById("date").value || !stopTimeInput.value) {
    incomplete = true;
  }
  
  if (incomplete) {
    Swal.fire('অসম্পূর্ণ!','অনুগ্রহ করে সমস্ত প্রয়োজনীয় ঘর পূরণ করুন।','warning');
    return;
  }

  // ১. সাবমিট করার আগে বাটন ডিসেবল এবং লোডিং টেক্সট দেখানো
  const originalButtonText = submitButton.textContent;
  submitButton.disabled = true;
  submitButton.textContent = 'সংরক্ষণ করা হচ্ছে...'; 

  const data = {
    workerId: workerSelect.value,
    workerName: workerSelect.options[workerSelect.selectedIndex].text,
    machine: document.getElementById("machine").value,
    date: document.getElementById("date").value,
    
    // **********************************************
    // বন্ধের সময় (Stop Time) ডেটা
    // **********************************************
    stopTime: stopTimeInput.value, // ডেটাবেসে stopTime নামে সেভ হবে
    notes: notesInput.value, // নোট
    // **********************************************
    
    works,
    grandTotal: grandTotalSpan.textContent,
    createdBy: auth.currentUser.email,
    createdAt: serverTimestamp()
  };

  try {
    await addDoc(collection(db, "productions"), data);
    
    Swal.fire('সংরক্ষিত!','উৎপাদন সফলভাবে সংরক্ষিত হয়েছে।','success');
    productionForm.reset();
    stopTimeInput.value = '00:00'; // stopTime ফিল্ডটি রিসেট করা
    stageContainer.innerHTML = '';
    createRow();
    grandTotalSpan.textContent = '0';
    
  } catch(err) {
    console.error(err);
    Swal.fire('ত্রুটি','উৎপাদন সংরক্ষণ করা যায়নি।','error');
  } finally {
    // ২. প্রক্রিয়া শেষ হওয়ার পরে বাটনটি আবার সক্রিয় করা এবং আগের টেক্সট ফিরিয়ে আনা
    submitButton.disabled = false;
    submitButton.textContent = originalButtonText;
  }
});

// Auth Check (No Change)
onAuthStateChanged(auth, async user => {
  if (authChecked) return;
  authChecked = true;

  if (!user) {
    window.location.href = "/account";
    return;
    }
  
  const usersRef = collection(db, "users");
  const q = query(usersRef, where("userId", "==", user.uid)); 
  
  try {
    const snapshot = await getDocs(q);

    let isAdmin = false;

    if (!snapshot.empty) {
      const userDoc = snapshot.docs[0];
      const role = userDoc.data().role;
      
      if (role && role.toLowerCase() === "admin") {
        isAdmin = true;
      }
    }

    if (isAdmin) {
      productionForm.classList.remove("hidden");
      document.getElementById("accessDenied").classList.add("hidden");
      await loadUsers(workerSelect); 
    } else {
      document.getElementById("accessDenied").classList.remove("hidden");
    }

  } catch (error) {
    console.error("Error fetching user role:", error);
    document.getElementById("accessDenied").classList.remove("hidden");
  } finally {
    loader.style.display = "none";
    document.body.style.display = "flex";
  }
});
</script>
</body>
</html>